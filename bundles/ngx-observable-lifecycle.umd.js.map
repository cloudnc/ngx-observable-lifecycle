{"version":3,"file":"ngx-observable-lifecycle.umd.js","sources":["ng://ngx-observable-lifecycle/lib/ivy-api.ts","ng://ngx-observable-lifecycle/lib/ngx-observable-lifecycle.ts"],"sourcesContent":["export const NG_COMPONENT_DEF = 'ɵcmp';\nexport const NG_DIRECTIVE_DEF = 'ɵdir';\n","import {\n  ɵComponentDef as ComponentDef,\n  ɵComponentType as ComponentType,\n  ɵDirectiveDef as DirectiveDef,\n  ɵDirectiveType as DirectiveType,\n} from '@angular/core';\nimport { Observable, Subject } from 'rxjs';\nimport { NG_COMPONENT_DEF, NG_DIRECTIVE_DEF } from './ivy-api';\n\nexport const hookProp: unique symbol = Symbol('ngx-observable-lifecycle-hooks');\nexport const hooksPatched: unique symbol = Symbol('ngx-observable-lifecycle-hooks-decorator');\nexport const allHooks: AllHookOptions = {\n  onChanges: true,\n  onInit: true,\n  doCheck: true,\n  afterContentInit: true,\n  afterContentChecked: true,\n  afterViewInit: true,\n  afterViewChecked: true,\n  onDestroy: true,\n};\n\ntype Writeable<T> = { -readonly [P in keyof T]: T[P] };\n\nexport type IvyDirective<T> = Writeable<DirectiveDef<T> | ComponentDef<T>>;\nexport type DecoratedDirective<T, U> = IvyDirective<T> & { [hooksPatched]?: HooksType<U, boolean> };\n\nfunction getLinkInfo<T, U>(type: DirectiveType<T> | ComponentType<T>): DecoratedDirective<T, U> {\n  return (type as ComponentType<T>)[NG_COMPONENT_DEF] || (type as DirectiveType<T>)[NG_DIRECTIVE_DEF];\n}\n\nexport type LifecycleHookKey =\n  | 'onChanges'\n  | 'onInit'\n  | 'doCheck'\n  | 'afterContentInit'\n  | 'afterContentChecked'\n  | 'afterViewInit'\n  | 'afterViewChecked'\n  | 'onDestroy';\n\ntype Hooks<T> = Pick<IvyDirective<T>, LifecycleHookKey>;\n\ntype AllHookOptions = Record<keyof Hooks<any>, true>;\ntype DecorateHookOptions = Partial<AllHookOptions>;\n\nexport type HooksType<T extends DecorateHookOptions, U> = {\n  [P in keyof T]: T[P] extends true ? U : never;\n};\n\nexport type DecoratedHooks<T> = HooksType<T, Observable<void>>;\nexport type DecoratedHooksSub<T> = HooksType<T, Subject<void>>;\n\nexport interface DecorateObservableOptions {\n  hooks: DecorateHookOptions;\n  incompatibleComponentError: Error;\n}\n\ntype DecoratedClassInstance<T> = { [hookProp]: DecoratedHooksSub<T> };\n\nfunction getSubjectForHook<T>(classInstance: DecoratedClassInstance<T>, hook: keyof T): Subject<void> {\n  if (!classInstance[hookProp]) {\n    classInstance[hookProp] = {} as DecoratedClassInstance<T>[typeof hookProp];\n  }\n\n  const hooks: DecoratedHooksSub<T> = classInstance[hookProp];\n\n  if (!hooks[hook]) {\n    (hooks[hook] as Subject<void>) = new Subject<void>();\n  }\n\n  return hooks[hook];\n}\n\nfunction closeHook<T>(classInstance: DecoratedClassInstance<T>, hook: keyof T): void {\n  classInstance[hookProp][hook]?.complete();\n  delete classInstance[hookProp][hook];\n}\n\n/**\n * Library authors should use this to create their own decorators\n */\nexport function decorateObservableLifecycle(\n  target: any,\n  { hooks, incompatibleComponentError }: DecorateObservableOptions,\n): void {\n  const linkInfo = getLinkInfo(target as any);\n\n  if (!linkInfo) {\n    throw incompatibleComponentError;\n  }\n\n  linkInfo[hooksPatched] = (Object.keys(hooks) as Array<LifecycleHookKey>).reduce(\n    (patched: HooksType<any, boolean>, hook) => {\n      // do not re-patch hooks that have already been patched\n      if (patched[hook]) {\n        return patched;\n      }\n\n      const originalHook = linkInfo[hook];\n\n      linkInfo[hook] = function (this: DecoratedClassInstance<any>) {\n        originalHook?.call(this);\n        getSubjectForHook(this, hook).next();\n      };\n\n      const originalOnDestroy = linkInfo.onDestroy;\n      linkInfo.onDestroy = function (this: DecoratedClassInstance<any>) {\n        originalOnDestroy?.call(this);\n        closeHook(this, hook);\n      };\n\n      patched[hook] = true;\n      return patched;\n    },\n    linkInfo[hooksPatched] ?? ({} as HooksType<any, boolean>),\n  );\n}\n\nexport interface GetLifecycleHooksOptions {\n  missingDecoratorError: Error;\n  incompatibleComponentError: Error;\n}\n\n/**\n * Library authors should use this to create their own lifecycle-aware functionality\n */\nexport function getLifecycleHooks<T extends DecorateHookOptions = {}>(\n  classInstance: any,\n  { incompatibleComponentError, missingDecoratorError }: GetLifecycleHooksOptions,\n): DecoratedHooks<T> {\n  const linkInfo = getLinkInfo(classInstance.constructor);\n\n  if (!linkInfo) {\n    throw incompatibleComponentError;\n  }\n\n  if (!linkInfo[hooksPatched]) {\n    throw missingDecoratorError;\n  }\n\n  return new Proxy({} as DecoratedHooks<T>, {\n    get(target: DecoratedHooks<T>, p: keyof T): Observable<void> {\n      return getSubjectForHook(classInstance, p).asObservable();\n    },\n  });\n}\n\nexport function getObservableLifecycle<T extends DecorateHookOptions = AllHookOptions>(target: any): DecoratedHooks<T> {\n  return getLifecycleHooks(target, {\n    missingDecoratorError: new Error(\n      'You must decorate the component or directive with @ObservableLifecycle for getObservableLifecycle to be able to function!',\n    ),\n    incompatibleComponentError: new Error(\n      `You must use getObservableLifecycle with a directive or component. This type (${target?.constructor.name}) is not compatible with getObservableLifecycle!`,\n    ),\n  });\n}\n\nexport function ObservableLifecycle(hooks: DecorateHookOptions = allHooks): ClassDecorator {\n  return target =>\n    decorateObservableLifecycle(target, {\n      hooks,\n      incompatibleComponentError: new Error(\n        `You must decorate a component or directive. This type (${target?.name}) is not compatible with @ObservableLifecycle!`,\n      ),\n    });\n}\n"],"names":["Subject"],"mappings":"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"}