import { Subject } from 'rxjs';
import { NG_COMPONENT_DEF, NG_DIRECTIVE_DEF } from './ivy-api';
export const hookProp = Symbol('ngx-observable-lifecycle-hooks');
export const hooksPatched = Symbol('ngx-observable-lifecycle-hooks-decorator');
export const allHooks = {
    onChanges: true,
    onInit: true,
    doCheck: true,
    afterContentInit: true,
    afterContentChecked: true,
    afterViewInit: true,
    afterViewChecked: true,
    onDestroy: true,
};
function getLinkInfo(type) {
    return type[NG_COMPONENT_DEF] || type[NG_DIRECTIVE_DEF];
}
function getSubjectForHook(classInstance, hook) {
    if (!classInstance[hookProp]) {
        classInstance[hookProp] = {};
    }
    const hooks = classInstance[hookProp];
    if (!hooks[hook]) {
        hooks[hook] = new Subject();
    }
    return hooks[hook];
}
function closeHook(classInstance, hook) {
    var _a;
    (_a = classInstance[hookProp][hook]) === null || _a === void 0 ? void 0 : _a.complete();
    delete classInstance[hookProp][hook];
}
/**
 * Library authors should use this to create their own decorators
 */
export function decorateObservableLifecycle(target, { hooks, incompatibleComponentError }) {
    var _a;
    const linkInfo = getLinkInfo(target);
    if (!linkInfo) {
        throw incompatibleComponentError;
    }
    linkInfo[hooksPatched] = Object.keys(hooks).reduce((patched, hook) => {
        // do not re-patch hooks that have already been patched
        if (patched[hook]) {
            return patched;
        }
        const originalHook = linkInfo[hook];
        linkInfo[hook] = function () {
            originalHook === null || originalHook === void 0 ? void 0 : originalHook.call(this);
            getSubjectForHook(this, hook).next();
        };
        const originalOnDestroy = linkInfo.onDestroy;
        linkInfo.onDestroy = function () {
            originalOnDestroy === null || originalOnDestroy === void 0 ? void 0 : originalOnDestroy.call(this);
            closeHook(this, hook);
        };
        patched[hook] = true;
        return patched;
    }, (_a = linkInfo[hooksPatched]) !== null && _a !== void 0 ? _a : {});
}
/**
 * Library authors should use this to create their own lifecycle-aware functionality
 */
export function getLifecycleHooks(classInstance, { incompatibleComponentError, missingDecoratorError }) {
    const linkInfo = getLinkInfo(classInstance.constructor);
    if (!linkInfo) {
        throw incompatibleComponentError;
    }
    if (!linkInfo[hooksPatched]) {
        throw missingDecoratorError;
    }
    return new Proxy({}, {
        get(target, p) {
            return getSubjectForHook(classInstance, p).asObservable();
        },
    });
}
export function getObservableLifecycle(target) {
    return getLifecycleHooks(target, {
        missingDecoratorError: new Error('You must decorate the component or directive with @ObservableLifecycle for getObservableLifecycle to be able to function!'),
        incompatibleComponentError: new Error(`You must use getObservableLifecycle with a directive or component. This type (${target === null || target === void 0 ? void 0 : target.constructor.name}) is not compatible with getObservableLifecycle!`),
    });
}
export function ObservableLifecycle(hooks = allHooks) {
    return target => decorateObservableLifecycle(target, {
        hooks,
        incompatibleComponentError: new Error(`You must decorate a component or directive. This type (${target === null || target === void 0 ? void 0 : target.name}) is not compatible with @ObservableLifecycle!`),
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoibmd4LW9ic2VydmFibGUtbGlmZWN5Y2xlLmpzIiwic291cmNlUm9vdCI6Im5nOi8vbmd4LW9ic2VydmFibGUtbGlmZWN5Y2xlLyIsInNvdXJjZXMiOlsibGliL25neC1vYnNlcnZhYmxlLWxpZmVjeWNsZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiQUFNQSxPQUFPLEVBQWMsT0FBTyxFQUFFLE1BQU0sTUFBTSxDQUFDO0FBQzNDLE9BQU8sRUFBRSxnQkFBZ0IsRUFBRSxnQkFBZ0IsRUFBRSxNQUFNLFdBQVcsQ0FBQztBQUUvRCxNQUFNLENBQUMsTUFBTSxRQUFRLEdBQWtCLE1BQU0sQ0FBQyxnQ0FBZ0MsQ0FBQyxDQUFDO0FBQ2hGLE1BQU0sQ0FBQyxNQUFNLFlBQVksR0FBa0IsTUFBTSxDQUFDLDBDQUEwQyxDQUFDLENBQUM7QUFDOUYsTUFBTSxDQUFDLE1BQU0sUUFBUSxHQUFtQjtJQUN0QyxTQUFTLEVBQUUsSUFBSTtJQUNmLE1BQU0sRUFBRSxJQUFJO0lBQ1osT0FBTyxFQUFFLElBQUk7SUFDYixnQkFBZ0IsRUFBRSxJQUFJO0lBQ3RCLG1CQUFtQixFQUFFLElBQUk7SUFDekIsYUFBYSxFQUFFLElBQUk7SUFDbkIsZ0JBQWdCLEVBQUUsSUFBSTtJQUN0QixTQUFTLEVBQUUsSUFBSTtDQUNoQixDQUFDO0FBT0YsU0FBUyxXQUFXLENBQU8sSUFBeUM7SUFDbEUsT0FBUSxJQUF5QixDQUFDLGdCQUFnQixDQUFDLElBQUssSUFBeUIsQ0FBQyxnQkFBZ0IsQ0FBQyxDQUFDO0FBQ3RHLENBQUM7QUErQkQsU0FBUyxpQkFBaUIsQ0FBSSxhQUF3QyxFQUFFLElBQWE7SUFDbkYsSUFBSSxDQUFDLGFBQWEsQ0FBQyxRQUFRLENBQUMsRUFBRTtRQUM1QixhQUFhLENBQUMsUUFBUSxDQUFDLEdBQUcsRUFBZ0QsQ0FBQztLQUM1RTtJQUVELE1BQU0sS0FBSyxHQUF5QixhQUFhLENBQUMsUUFBUSxDQUFDLENBQUM7SUFFNUQsSUFBSSxDQUFDLEtBQUssQ0FBQyxJQUFJ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SjtLQUNGLENBQUMsQ0FBQztBQUNMLENBQUM7QUFFRCxNQUFNLFVBQVUsbUJBQW1CLENBQUMsUUFBNkIsUUFBUTtJQUN2RSxPQUFPLE1BQU0sQ0FBQyxFQUFFLENBQ2QsMkJBQTJCLENBQUMsTUFBTSxFQUFFO1FBQ2xDLEtBQUs7UUFDTCwwQkFBMEIsRUFBRSxJQUFJLEtBQUssQ0FDbkMsMERBQTBELE1BQU0sYUFBTixNQUFNLHVCQUFOLE1BQU0sQ0FBRSxJQUFJLGdEQUFnRCxDQUN2SDtLQUNGLENBQUMsQ0FBQztBQUNQLENBQUMiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQge1xuICDJtUNvbXBvbmVudERlZiBhcyBDb21wb25lbnREZWYsXG4gIMm1Q29tcG9uZW50VHlwZSBhcyBDb21wb25lbnRUeXBlLFxuICDJtURpcmVjdGl2ZURlZiBhcyBEaXJlY3RpdmVEZWYsXG4gIMm1RGlyZWN0aXZlVHlwZSBhcyBEaXJlY3RpdmVUeXBlLFxufSBmcm9tICdAYW5ndWxhci9jb3JlJztcbmltcG9ydCB7IE9ic2VydmFibGUsIFN1YmplY3QgfSBmcm9tICdyeGpzJztcbmltcG9ydCB7IE5HX0NPTVBPTkVOVF9ERUYsIE5HX0RJUkVDVElWRV9ERUYgfSBmcm9tICcuL2l2eS1hcGknO1xuXG5leHBvcnQgY29uc3QgaG9va1Byb3A6IHVuaXF1ZSBzeW1ib2wgPSBTeW1ib2woJ25neC1vYnNlcnZhYmxlLWxpZmVjeWNsZS1ob29rcycpO1xuZXhwb3J0IGNvbnN0IGhvb2tzUGF0Y2hlZDogdW5pcXVlIHN5bWJvbCA9IFN5bWJvbCgnbmd4LW9ic2VydmFibGUtbGlmZWN5Y2xlLWhvb2tzLWRlY29yYXRvcicpO1xuZXhwb3J0IGNvbnN0IGFsbEhvb2tzOiBBbGxIb29rT3B0aW9ucyA9IHtcbiAgb25DaGFuZ2VzOiB0cnVlLFxuICBvbkluaXQ6IHRydWUsXG4gIGRvQ2hlY2s6IHRydWUsXG4gIGFmdGVyQ29udGVudEluaXQ6IHRydWUsXG4gIGFmdGVyQ29udGVudENoZWNrZWQ6IHRydWUsXG4gIGFmdGVyVmlld0luaXQ6IHRydWUsXG4gIGFmdGVyVmlld0NoZWNrZWQ6IHRydWUsXG4gIG9uRGVzdHJveTogdHJ1ZSxcbn07XG5cbnR5cGUgV3JpdGVhYmxlPFQ+ID0geyAtcmVhZG9ubHkgW1AgaW4ga2V5b2YgVF06IFRbUF0gfTtcblxuZXhwb3J0IHR5cGUgSXZ5RGlyZWN0aXZlPFQ+ID0gV3JpdGVhYmxlPERpcmVjdGl2ZURlZjxUPiB8IENvbXBvbmVudERlZjxUPj47XG5leHBvcnQgdHlwZSBEZWNvcmF0ZWREaXJlY3RpdmU8VCwgVT4gPSBJdnlEaXJlY3RpdmU8VD4gJiB7IFtob29rc1BhdGNoZWRdPzogSG9va3NUeXBlPFUsIGJvb2xlYW4+IH07XG5cbmZ1bmN0aW9uIGdldExpbmtJbmZvPFQsIFU+KHR5cGU6IERpcmVjdGl2ZVR5cGU8VD4gfCBDb21wb25lbnRUeXBlPFQ+KTogRGVjb3JhdGVkRGlyZWN0aXZlPFQsIFU+IHtcbiAgcmV0dXJuICh0eXBlIGFzIENvbXBvbmVudFR5cGU8VD4pW05HX0NPTVBPTkVOVF9ERUZdIHx8ICh0eXBlIGFzIERpcmVjdGl2ZVR5cGU8VD4pW05HX0RJUkVDVElWRV9ERUZdO1xufVxuXG5leHBvcnQgdHlwZSBMaWZlY3ljbGVIb29rS2V5ID1cbiAgfCAnb25DaGFuZ2VzJ1xuICB8ICdvbkluaXQnXG4gIHwgJ2RvQ2hlY2snXG4gIHwgJ2FmdGVyQ29udGVudEluaXQnXG4gIHwgJ2FmdGVyQ29udGVudENoZWNrZWQnXG4gIHwgJ2FmdGVyVmlld0luaXQnXG4gIHwgJ2FmdGVyVmlld0NoZWNrZWQnXG4gIHwgJ29uRGVzdHJveSc7XG5cbnR5cGUgSG9va3M8VD4gPSBQaWNrPEl2eURpcmVjdGl2ZTxUPiwgTGlmZWN5Y2xlSG9va0tleT47XG5cbnR5cGUgQWxsSG9va09wdGlvbnMgPSBSZWNvcmQ8a2V5b2YgSG9va3M8YW55PiwgdHJ1ZT47XG50eXBlIERlY29yYXRlSG9va09wdGlvbnMgPSBQYXJ0aWFsPEFsbEhvb2tPcHRpb25zPjtcblxuZXhwb3J0IHR5cGUgSG9va3NUeXBlPFQgZXh0ZW5kcyBEZWNvcmF0ZUhvb2tPcHRpb25zLCBVPiA9IHtcbiAgW1AgaW4ga2V5b2YgVF06IFRbUF0gZXh0ZW5kcyB0cnVlID8gVSA6IG5ldmVyO1xufTtcblxuZXhwb3J0IHR5cGUgRGVjb3JhdGVkSG9va3M8VD4gPSBIb29rc1R5cGU8VCwgT2JzZXJ2YWJsZTx2b2lkPj47XG5leHBvcnQgdHlwZSBEZWNvcmF0ZWRIb29rc1N1YjxUPiA9IEhvb2tzVHlwZTxULCBTdWJqZWN0PHZvaWQ+PjtcblxuZXhwb3J0IGludGVyZmFjZSBEZWNvcmF0ZU9ic2VydmFibGVPcHRpb25zIHtcbiAgaG9va3M6IERlY29yYXRlSG9va09wdGlvbnM7XG4gIGluY29tcGF0aWJsZUNvbXBvbmVudEVycm9yOiBFcnJvcjtcbn1cblxudHlwZSBEZWNvcmF0ZWRDbGFzc0luc3RhbmNlPFQ+ID0geyBbaG9va1Byb3BdOiBEZWNvcmF0ZWRIb29rc1N1YjxUPiB9O1xuXG5mdW5jdGlvbiBnZXRTdWJqZWN0Rm9ySG9vazxUPihjbGFzc0luc3RhbmNlOiBEZWNvcmF0ZWRDbGFzc0luc3RhbmNlPFQ+LCBob29rOiBrZXlvZiBUKTogU3ViamVjdDx2b2lkPiB7XG4gIGlmICghY2xhc3NJbnN0YW5jZVtob29rUHJvcF0pIHtcbiAgICBjbGFzc0luc3RhbmNlW2hvb2tQcm9wXSA9IHt9IGFzIERlY29yYXRlZENsYXNzSW5zdGFuY2U8VD5bdHlwZW9mIGhvb2tQcm9wXTtcbiAgfVxuXG4gIGNvbnN0IGhvb2tzOiBEZWNvcmF0ZWRIb29rc1N1YjxUPiA9IGNsYXNzSW5zdGFuY2VbaG9va1Byb3BdO1xuXG4gIGlmICghaG9va3NbaG9va10pIHtcbiAgICAoaG9va3NbaG9va10gYXMgU3ViamVjdDx2b2lkPikgPSBuZXcgU3ViamVjdDx2b2lkPigpO1xuICB9XG5cbiAgcmV0dXJuIGhvb2tzW2hvb2tdO1xufVxuXG5mdW5jdGlvbiBjbG9zZUhvb2s8VD4oY2xhc3NJbnN0YW5jZTogRGVjb3JhdGVkQ2xhc3NJbnN0YW5jZTxUPiwgaG9vazoga2V5b2YgVCk6IHZvaWQge1xuICBjbGFzc0luc3RhbmNlW2hvb2tQcm9wXVtob29rXT8uY29tcGxldGUoKTtcbiAgZGVsZXRlIGNsYXNzSW5zdGFuY2VbaG9va1Byb3BdW2hvb2tdO1xufVxuXG4vKipcbiAqIExpYnJhcnkgYXV0aG9ycyBzaG91bGQgdXNlIHRoaXMgdG8gY3JlYXRlIHRoZWlyIG93biBkZWNvcmF0b3JzXG4gKi9cbmV4cG9ydCBmdW5jdGlvbiBkZWNvcmF0ZU9ic2VydmFibGVMaWZlY3ljbGUoXG4gIHRhcmdldDogYW55LFxuICB7IGhvb2tzLCBpbmNvbXBhdGlibGVDb21wb25lbnRFcnJvciB9OiBEZWNvcmF0ZU9ic2VydmFibGVPcHRpb25zLFxuKTogdm9pZCB7XG4gIGNvbnN0IGxpbmtJbmZvID0gZ2V0TGlua0luZm8odGFyZ2V0IGFzIGFueSk7XG5cbiAgaWYgKCFsaW5rSW5mbykge1xuICAgIHRocm93IGluY29tcGF0aWJsZUNvbXBvbmVudEVycm9yO1xuICB9XG5cbiAgbGlua0luZm9baG9va3NQYXRjaGVkXSA9IChPYmplY3Qua2V5cyhob29rcykgYXMgQXJyYXk8TGlmZWN5Y2xlSG9va0tleT4pLnJlZHVjZShcbiAgICAocGF0Y2hlZDogSG9va3NUeXBlPGFueSwgYm9vbGVhbj4sIGhvb2spID0+IHtcbiAgICAgIC8vIGRvIG5vdCByZS1wYXRjaCBob29rcyB0aGF0IGhhdmUgYWxyZWFkeSBiZWVuIHBhdGNoZWRcbiAgICAgIGlmIChwYXRjaGVkW2hvb2tdKSB7XG4gICAgICAgIHJldHVybiBwYXRjaGVkO1xuICAgICAgfVxuXG4gICAgICBjb25zdCBvcmlnaW5hbEhvb2sgPSBsaW5rSW5mb1tob29rXTtcblxuICAgICAgbGlua0luZm9baG9va10gPSBmdW5jdGlvbiAodGhpczogRGVjb3JhdGVkQ2xhc3NJbnN0YW5jZTxhbnk+KSB7XG4gICAgICAgIG9yaWdpbmFsSG9vaz8uY2FsbCh0aGlzKTtcbiAgICAgICAgZ2V0U3ViamVjdEZvckhvb2sodGhpcywgaG9vaykubmV4dCgpO1xuICAgICAgfTtcblxuICAgICAgY29uc3Qgb3JpZ2luYWxPbkRlc3Ryb3kgPSBsaW5rSW5mby5vbkRlc3Ryb3k7XG4gICAgICBsaW5rSW5mby5vbkRlc3Ryb3kgPSBmdW5jdGlvbiAodGhpczogRGVjb3JhdGVkQ2xhc3NJbnN0YW5jZTxhbnk+KSB7XG4gICAgICAgIG9yaWdpbmFsT25EZXN0cm95Py5jYWxsKHRoaXMpO1xuICAgICAgICBjbG9zZUhvb2sodGhpcywgaG9vayk7XG4gICAgICB9O1xuXG4gICAgICBwYXRjaGVkW2hvb2tdID0gdHJ1ZTtcbiAgICAgIHJldHVybiBwYXRjaGVkO1xuICAgIH0sXG4gICAgbGlua0luZm9baG9va3NQYXRjaGVkXSA/PyAoe30gYXMgSG9va3NUeXBlPGFueSwgYm9vbGVhbj4pLFxuICApO1xufVxuXG5leHBvcnQgaW50ZXJmYWNlIEdldExpZmVjeWNsZUhvb2tzT3B0aW9ucyB7XG4gIG1pc3NpbmdEZWNvcmF0b3JFcnJvcjogRXJyb3I7XG4gIGluY29tcGF0aWJsZUNvbXBvbmVudEVycm9yOiBFcnJvcjtcbn1cblxuLyoqXG4gKiBMaWJyYXJ5IGF1dGhvcnMgc2hvdWxkIHVzZSB0aGlzIHRvIGNyZWF0ZSB0aGVpciBvd24gbGlmZWN5Y2xlLWF3YXJlIGZ1bmN0aW9uYWxpdHlcbiAqL1xuZXhwb3J0IGZ1bmN0aW9uIGdldExpZmVjeWNsZUhvb2tzPFQgZXh0ZW5kcyBEZWNvcmF0ZUhvb2tPcHRpb25zID0ge30+KFxuICBjbGFzc0luc3RhbmNlOiBhbnksXG4gIHsgaW5jb21wYXRpYmxlQ29tcG9uZW50RXJyb3IsIG1pc3NpbmdEZWNvcmF0b3JFcnJvciB9OiBHZXRMaWZlY3ljbGVIb29rc09wdGlvbnMsXG4pOiBEZWNvcmF0ZWRIb29rczxUPiB7XG4gIGNvbnN0IGxpbmtJbmZvID0gZ2V0TGlua0luZm8oY2xhc3NJbnN0YW5jZS5jb25zdHJ1Y3Rvcik7XG5cbiAgaWYgKCFsaW5rSW5mbykge1xuICAgIHRocm93IGluY29tcGF0aWJsZUNvbXBvbmVudEVycm9yO1xuICB9XG5cbiAgaWYgKCFsaW5rSW5mb1tob29rc1BhdGNoZWRdKSB7XG4gICAgdGhyb3cgbWlzc2luZ0RlY29yYXRvckVycm9yO1xuICB9XG5cbiAgcmV0dXJuIG5ldyBQcm94eSh7fSBhcyBEZWNvcmF0ZWRIb29rczxUPiwge1xuICAgIGdldCh0YXJnZXQ6IERlY29yYXRlZEhvb2tzPFQ+LCBwOiBrZXlvZiBUKTogT2JzZXJ2YWJsZTx2b2lkPiB7XG4gICAgICByZXR1cm4gZ2V0U3ViamVjdEZvckhvb2soY2xhc3NJbnN0YW5jZSwgcCkuYXNPYnNlcnZhYmxlKCk7XG4gICAgfSxcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBnZXRPYnNlcnZhYmxlTGlmZWN5Y2xlPFQgZXh0ZW5kcyBEZWNvcmF0ZUhvb2tPcHRpb25zID0gQWxsSG9va09wdGlvbnM+KHRhcmdldDogYW55KTogRGVjb3JhdGVkSG9va3M8VD4ge1xuICByZXR1cm4gZ2V0TGlmZWN5Y2xlSG9va3ModGFyZ2V0LCB7XG4gICAgbWlzc2luZ0RlY29yYXRvckVycm9yOiBuZXcgRXJyb3IoXG4gICAgICAnWW91IG11c3QgZGVjb3JhdGUgdGhlIGNvbXBvbmVudCBvciBkaXJlY3RpdmUgd2l0aCBAT2JzZXJ2YWJsZUxpZmVjeWNsZSBmb3IgZ2V0T2JzZXJ2YWJsZUxpZmVjeWNsZSB0byBiZSBhYmxlIHRvIGZ1bmN0aW9uIScsXG4gICAgKSxcbiAgICBpbmNvbXBhdGlibGVDb21wb25lbnRFcnJvcjogbmV3IEVycm9yKFxuICAgICAgYFlvdSBtdXN0IHVzZSBnZXRPYnNlcnZhYmxlTGlmZWN5Y2xlIHdpdGggYSBkaXJlY3RpdmUgb3IgY29tcG9uZW50LiBUaGlzIHR5cGUgKCR7dGFyZ2V0Py5jb25zdHJ1Y3Rvci5uYW1lfSkgaXMgbm90IGNvbXBhdGlibGUgd2l0aCBnZXRPYnNlcnZhYmxlTGlmZWN5Y2xlIWAsXG4gICAgKSxcbiAgfSk7XG59XG5cbmV4cG9ydCBmdW5jdGlvbiBPYnNlcnZhYmxlTGlmZWN5Y2xlKGhvb2tzOiBEZWNvcmF0ZUhvb2tPcHRpb25zID0gYWxsSG9va3MpOiBDbGFzc0RlY29yYXRvciB7XG4gIHJldHVybiB0YXJnZXQgPT5cbiAgICBkZWNvcmF0ZU9ic2VydmFibGVMaWZlY3ljbGUodGFyZ2V0LCB7XG4gICAgICBob29rcyxcbiAgICAgIGluY29tcGF0aWJsZUNvbXBvbmVudEVycm9yOiBuZXcgRXJyb3IoXG4gICAgICAgIGBZb3UgbXVzdCBkZWNvcmF0ZSBhIGNvbXBvbmVudCBvciBkaXJlY3RpdmUuIFRoaXMgdHlwZSAoJHt0YXJnZXQ/Lm5hbWV9KSBpcyBub3QgY29tcGF0aWJsZSB3aXRoIEBPYnNlcnZhYmxlTGlmZWN5Y2xlIWAsXG4gICAgICApLFxuICAgIH0pO1xufVxuIl19