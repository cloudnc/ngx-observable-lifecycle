{"version":3,"file":"ngx-observable-lifecycle.js","sources":["ng://ngx-observable-lifecycle/lib/ivy-api.ts","ng://ngx-observable-lifecycle/lib/ngx-observable-lifecycle.ts","ng://ngx-observable-lifecycle/public-api.ts","ng://ngx-observable-lifecycle/ngx-observable-lifecycle.ts"],"sourcesContent":["export const NG_COMPONENT_DEF = 'ɵcmp';\nexport const NG_DIRECTIVE_DEF = 'ɵdir';\n","import {\n  ɵComponentDef as ComponentDef,\n  ɵComponentType as ComponentType,\n  ɵDirectiveDef as DirectiveDef,\n  ɵDirectiveType as DirectiveType,\n} from '@angular/core';\nimport { Observable, Subject } from 'rxjs';\nimport { NG_COMPONENT_DEF, NG_DIRECTIVE_DEF } from './ivy-api';\n\nexport const hookProp: unique symbol = Symbol('ngx-observable-lifecycle-hooks');\nexport const hooksPatched: unique symbol = Symbol('ngx-observable-lifecycle-hooks-decorator');\nexport const allHooks: AllHookOptions = {\n  onChanges: true,\n  onInit: true,\n  doCheck: true,\n  afterContentInit: true,\n  afterContentChecked: true,\n  afterViewInit: true,\n  afterViewChecked: true,\n  onDestroy: true,\n};\n\ntype Writeable<T> = { -readonly [P in keyof T]: T[P] };\n\nexport type IvyDirective<T> = Writeable<DirectiveDef<T> | ComponentDef<T>>;\nexport type DecoratedDirective<T, U> = IvyDirective<T> & { [hooksPatched]?: HooksType<U, boolean> };\n\nfunction getLinkInfo<T, U>(type: DirectiveType<T> | ComponentType<T>): DecoratedDirective<T, U> {\n  return (type as ComponentType<T>)[NG_COMPONENT_DEF] || (type as DirectiveType<T>)[NG_DIRECTIVE_DEF];\n}\n\nexport type LifecycleHookKey =\n  | 'onChanges'\n  | 'onInit'\n  | 'doCheck'\n  | 'afterContentInit'\n  | 'afterContentChecked'\n  | 'afterViewInit'\n  | 'afterViewChecked'\n  | 'onDestroy';\n\ntype Hooks<T> = Pick<IvyDirective<T>, LifecycleHookKey>;\n\ntype AllHookOptions = Record<keyof Hooks<any>, true>;\ntype DecorateHookOptions = Partial<AllHookOptions>;\n\nexport type HooksType<T extends DecorateHookOptions, U> = {\n  [P in keyof T]: T[P] extends true ? U : never;\n};\n\nexport type DecoratedHooks<T> = HooksType<T, Observable<void>>;\nexport type DecoratedHooksSub<T> = HooksType<T, Subject<void>>;\n\nexport interface DecorateObservableOptions {\n  hooks: DecorateHookOptions;\n  incompatibleComponentError: Error;\n}\n\ntype DecoratedClassInstance<T> = { [hookProp]: DecoratedHooksSub<T> };\n\nfunction getSubjectForHook<T>(classInstance: DecoratedClassInstance<T>, hook: keyof T): Subject<void> {\n  if (!classInstance[hookProp]) {\n    classInstance[hookProp] = {} as DecoratedClassInstance<T>[typeof hookProp];\n  }\n\n  const hooks: DecoratedHooksSub<T> = classInstance[hookProp];\n\n  if (!hooks[hook]) {\n    (hooks[hook] as Subject<void>) = new Subject<void>();\n  }\n\n  return hooks[hook];\n}\n\nfunction closeHook<T>(classInstance: DecoratedClassInstance<T>, hook: keyof T): void {\n  classInstance[hookProp][hook]?.complete();\n  delete classInstance[hookProp][hook];\n}\n\n/**\n * Library authors should use this to create their own decorators\n */\nexport function decorateObservableLifecycle(\n  target: any,\n  { hooks, incompatibleComponentError }: DecorateObservableOptions,\n): void {\n  const linkInfo = getLinkInfo(target as any);\n\n  if (!linkInfo) {\n    throw incompatibleComponentError;\n  }\n\n  linkInfo[hooksPatched] = (Object.keys(hooks) as Array<LifecycleHookKey>).reduce(\n    (patched: HooksType<any, boolean>, hook) => {\n      // do not re-patch hooks that have already been patched\n      if (patched[hook]) {\n        return patched;\n      }\n\n      const originalHook = linkInfo[hook];\n\n      linkInfo[hook] = function (this: DecoratedClassInstance<any>) {\n        originalHook?.call(this);\n        getSubjectForHook(this, hook).next();\n      };\n\n      const originalOnDestroy = linkInfo.onDestroy;\n      linkInfo.onDestroy = function (this: DecoratedClassInstance<any>) {\n        originalOnDestroy?.call(this);\n        closeHook(this, hook);\n      };\n\n      patched[hook] = true;\n      return patched;\n    },\n    linkInfo[hooksPatched] ?? ({} as HooksType<any, boolean>),\n  );\n}\n\nexport interface GetLifecycleHooksOptions {\n  missingDecoratorError: Error;\n  incompatibleComponentError: Error;\n}\n\n/**\n * Library authors should use this to create their own lifecycle-aware functionality\n */\nexport function getLifecycleHooks<T extends DecorateHookOptions = {}>(\n  classInstance: any,\n  { incompatibleComponentError, missingDecoratorError }: GetLifecycleHooksOptions,\n): DecoratedHooks<T> {\n  const linkInfo = getLinkInfo(classInstance.constructor);\n\n  if (!linkInfo) {\n    throw incompatibleComponentError;\n  }\n\n  if (!linkInfo[hooksPatched]) {\n    throw missingDecoratorError;\n  }\n\n  return new Proxy({} as DecoratedHooks<T>, {\n    get(target: DecoratedHooks<T>, p: keyof T): Observable<void> {\n      return getSubjectForHook(classInstance, p).asObservable();\n    },\n  });\n}\n\nexport function getObservableLifecycle<T extends DecorateHookOptions = AllHookOptions>(target: any): DecoratedHooks<T> {\n  return getLifecycleHooks(target, {\n    missingDecoratorError: new Error(\n      'You must decorate the component or directive with @ObservableLifecycle for getObservableLifecycle to be able to function!',\n    ),\n    incompatibleComponentError: new Error(\n      `You must use getObservableLifecycle with a directive or component. This type (${target?.constructor.name}) is not compatible with getObservableLifecycle!`,\n    ),\n  });\n}\n\nexport function ObservableLifecycle(hooks: DecorateHookOptions = allHooks): ClassDecorator {\n  return target =>\n    decorateObservableLifecycle(target, {\n      hooks,\n      incompatibleComponentError: new Error(\n        `You must decorate a component or directive. This type (${target?.name}) is not compatible with @ObservableLifecycle!`,\n      ),\n    });\n}\n","/*\n * Public API Surface of ngx-observable-lifecycle\n */\n\nexport * from './lib/ngx-observable-lifecycle';\n","/**\n * Generated bundle index. Do not edit.\n */\n\nexport * from './public-api';\n"],"names":[],"mappings":"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"}